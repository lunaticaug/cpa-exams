# 표 추출 오류 방지 가이드

## 1. 프롬프트 개선 전략

### 기존 프롬프트의 문제점
- 너무 일반적인 지시
- 표의 특수한 구조에 대한 언급 부족
- 데이터 검증 단계 없음

### 개선된 프롬프트
```markdown
이미지의 표를 추출할 때 다음 단계를 따라주세요:

1. **표 구조 파악**
   - 먼저 전체 행과 열의 개수를 세어주세요
   - 병합된 셀이 있는지 확인하세요
   - 헤더가 몇 단계인지 파악하세요

2. **데이터 추출**
   - 각 셀의 내용을 왼쪽→오른쪽, 위→아래 순서로 읽어주세요
   - 빈 셀도 명시적으로 표시하세요
   - "(단위:시간)" 같은 텍스트가 별도 행인지 같은 행인지 명확히 구분하세요

3. **검증**
   - 각 행의 숫자 개수가 열 개수와 일치하는지 확인
   - 행/열 합계가 논리적인지 검증
   - 예: 수선부문이 제공하는 총 시간 = 400+160+160+480+800 = 2,000시간

4. **출력 형식**
   먼저 원시 데이터를 제공한 후, 정리된 표를 제공:
   ```
   원시 데이터:
   행1: [제공부문, 수선, 식당, X, Y, Z]
   행2: [수선(단위:시간), 400, 160, 160, 480, 800]
   행3: [식당(단위:명), 54, 60, 162, 108, 216]
   ```
```

## 2. 단계별 추출 방식

### Step 1: 표 스캔
```python
def scan_table_structure(image):
    """
    1. 표의 경계선 감지
    2. 행/열 개수 파악
    3. 병합된 셀 위치 표시
    """
    return {
        "rows": 4,
        "cols": 6,
        "merged_cells": [(0,1,2), (0,3,5)],  # 헤더의 병합
        "has_units": True  # 단위 표시 있음
    }
```

### Step 2: 셀별 추출
```python
def extract_cell_by_cell(image, structure):
    """
    각 셀을 개별적으로 추출하여 2차원 배열로 저장
    """
    cells = []
    for row in range(structure["rows"]):
        row_data = []
        for col in range(structure["cols"]):
            cell_content = extract_single_cell(image, row, col)
            row_data.append(cell_content)
        cells.append(row_data)
    return cells
```

### Step 3: 구조 해석
```python
def interpret_table_structure(cells):
    """
    추출된 셀 데이터를 의미있는 구조로 변환
    """
    # "(단위:시간)"이 별도 행인지 같은 셀인지 판단
    # 숫자 패턴으로 데이터 행 식별
    # 헤더와 데이터 구분
```

## 3. 검증 체크리스트

### 자동 검증 항목
1. **행/열 수 일치**: 모든 행의 셀 개수가 동일한가?
2. **숫자 패턴**: 숫자가 있어야 할 곳에 숫자가 있는가?
3. **합계 검증**: 행/열 합계가 논리적인가?
4. **대칭성**: 상호배분표의 경우 대칭 구조인가?

### 의심 신호
- 한 행에만 데이터가 몰려있음
- 첫 번째 데이터 열이 모두 비어있음
- 단위 표시가 독립된 행으로 나타남

## 4. 실제 적용 예시

### 잘못된 추출
```
수선(단위:시간) | - | - | 160 | 480 | 800
식당(단위:명) | 400 | 160 | 162 | 108 | 216
```

### 올바른 추출
```
수선(단위:시간) | 400 | 160 | 160 | 480 | 800
식당(단위:명) | 54 | 60 | 162 | 108 | 216
```

### 차이점
- 수선부문의 첫 두 열(400, 160)이 누락됨
- 식당부문의 첫 두 열(54, 60)이 잘못된 위치에

## 5. 추천 워크플로우

1. **이미지 전처리**
   - 표 영역만 크롭
   - 대비 향상
   - 경계선 강조

2. **다중 추출 시도**
   - 일반 추출
   - 셀 단위 추출
   - OCR 기반 추출

3. **교차 검증**
   - 세 가지 방법의 결과 비교
   - 불일치 부분 수동 확인

4. **사용자 확인**
   - 복잡한 표는 추출 결과 미리보기 제공
   - "이 표가 올바르게 추출되었나요?" 확인

## 6. 코드 구현 예시

```python
class ImprovedTableExtractor:
    def extract_table(self, image_path):
        # 1. 구조 분석
        structure = self.analyze_structure(image_path)
        print(f"발견된 표: {structure['rows']}행 × {structure['cols']}열")
        
        # 2. 셀별 추출
        raw_cells = self.extract_cells(image_path, structure)
        
        # 3. 데이터 검증
        validation_result = self.validate_data(raw_cells)
        if not validation_result['valid']:
            print(f"⚠️ 경고: {validation_result['issues']}")
            
        # 4. 사용자 확인
        if structure['complexity'] > 0.7:
            print("복잡한 표 구조가 감지되었습니다.")
            self.show_preview(raw_cells)
            if not self.get_user_confirmation():
                return self.manual_correction(raw_cells)
                
        return self.format_table(raw_cells)
```

이러한 체계적인 접근으로 표 추출 정확도를 크게 향상시킬 수 있습니다!